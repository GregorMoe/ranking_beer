<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>BEERS</title>

<style>
body {
  font-family: system-ui;
  max-width: 900px;
  margin: 40px auto;
}

h1 { margin-bottom: 10px; }

form {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}

button {
  padding: 8px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th, td {
  border: 1px solid #ccc;
  padding: 6px;
  text-align: center;
}

</style>
</head>
<body>

<h1>Beer & Equivalents Educational Research System</h1>
<form id="entryForm">
  <!-- Drinker row -->
  <div style="margin-bottom: 10px;">
    <label for="drinker">Drinker:</label>
    <input type="text" id="drinker" placeholder="Your name" required>
  </div>

  <!-- Beer, Volume, Rating row -->
  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
    <select id="beer">
      <option>Lager</option>
      <option>IPA</option>
      <option>Stout</option>
      <option>Sour</option>
      <option>Pilsner</option>
    </select>

    <input type="number" id="volume" placeholder="Volume (ml)" min="0" required>
    <input type="number" id="rating" placeholder="Rating (0–10)" step="0.1" min="0" max="10" required>
  </div>

  <!-- Buttons -->
  <div style="margin-top: 10px;">
    <button type="submit">Add drink</button>
    <button type="button" id="download">Export CSV</button>
    <button type="button" id="clear">Clear</button>
  </div>
</form>


<table id="log">
<thead>
<tr>
  <th>n</th>
  <th>Drinker</th>
  <th>Beer</th>
  <th>Volume kₙ</th>
  <th>Σ volume</th>
  <th>Yₙ₋₁</th>
  <th>Rating Yₙ</th>
</tr>
</thead>
<tbody></tbody>
</table>

<!-- <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const SUPABASE_URL = 'https://xvmgtbvyhltnqzzbxvnc.supabase.co';
const SUPABASE_KEY = 'sb_publishable_4MZBvhrvtDRaf2HgiXOUHg_-PEvT_Qp';
const supabaseInstance = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let data = [];
let cumulativeVolume = 0;
let lastRating = null;

const form = document.getElementById("entryForm");
const tableBody = document.querySelector("#log tbody");

form.onsubmit = async (e) => {
  e.preventDefault();

  const drinker = document.getElementById("drinker").value;
  const beer = document.getElementById("beer").value;
  const volume = parseFloat(document.getElementById("volume").value);
  const rating = parseFloat(document.getElementById("rating").value);

  cumulativeVolume += volume;

  const row = {
    n: data.length + 1,
    drinker,
    beer,
    volume,
    cumulativeVolume,
    Y_lag: lastRating,
    rating
  };

  // Save to Supabase
  const { error } = await supabaseInstance
    .from('beer_ratings')
    .insert([{
      drinker: row.drinker,
      beer: row.beer,
      volume: row.volume,
      cum_volume: row.cumulativeVolume,
      Y_lag: row.Y_lag,
      rating: row.rating
    }]);

  if (error) {
    alert('Error saving to database: ' + error.message);
    return;
  }

  data.push(row);
  lastRating = rating;

  render();
  form.reset();
};


function render() {
  tableBody.innerHTML = "";
  data.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.n}</td>
      <td>${r.drinker}</td>
      <td>${r.beer}</td>
      <td>${r.volume}</td>
      <td>${r.cumulativeVolume}</td>
      <td>${r.Y_lag ?? "-"}</td>
      <td>${r.rating}</td>
    `;
    tableBody.appendChild(tr);
  });
}
document.getElementById("download").onclick = () => {
  const header = Object.keys(data[0]).join(",");
  const rows = data.map(r => Object.values(r).join(","));
  const csv = [header, ...rows].join("\n");

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "beer_ratings.csv";
  a.click();
};

document.getElementById("clear").onclick = () => {
  data = [];
  cumulativeVolume = 0;
  lastRating = null;
  render();
};

</script>

</body>
</html>
